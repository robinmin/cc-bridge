# Base image
FROM oven/bun:1-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    # Essential tools
    git \
    curl \
    jq \
    sudo \
    # Process & system monitoring
    procps \
    psmisc \
    htop \
    lsof \
    # Development tools
    ripgrep \
    fd-find \
    tree \
    file \
    less \
    tmux \
    # Text editor
    nano \
    # Cleanup
    && rm -rf /var/lib/apt/lists/*

# ARG for dynamic user creation
ARG USER_NAME=bun
ARG USER_ID=1000
ARG GROUP_ID=1000
ARG WORKSPACE_NAME=cc-bridge

# Create a group and user matching the host
# We use /Users/${USER_NAME} to match macOS structure
RUN groupadd -g ${GROUP_ID} ${USER_NAME} || true && \
    useradd -u ${USER_ID} -g ${GROUP_ID} -m -s /bin/bash -d /Users/${USER_NAME} ${USER_NAME} || true

# Ensure the home directory exists and is owned by the user (as root)
RUN mkdir -p /Users/${USER_NAME}/.claude && \
    chown -R ${USER_ID}:${GROUP_ID} /Users

# Ensure sudo privileges for the new user
RUN echo "${USER_NAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Ensure workspace directory structure exists and is writable
RUN mkdir -p /workspaces && \
    chown -R ${USER_ID}:${GROUP_ID} /workspaces

# Also keep /app for agent code execution
RUN mkdir -p /app && \
    chown -R ${USER_ID}:${GROUP_ID} /app

# Switch to non-root user
USER ${USER_NAME}

# Install Claude tools in /app (NOT affected by volume mounts)
WORKDIR /app
RUN bun add @anthropic-ai/claude-code @anthropic-ai/claude-agent-sdk

# Add local bin to PATH
ENV PATH="/app/node_modules/.bin:${PATH}"

# Set working directory to workspace (dynamic based on build arg)
WORKDIR /workspaces/${WORKSPACE_NAME}

# Copy dependency definitions
COPY --chown=${USER_NAME}:${USER_NAME} package.json bun.lock ./

# Copy internal packages and source
COPY --chown=${USER_NAME}:${USER_NAME} tsconfig.json ./
COPY --chown=${USER_NAME}:${USER_NAME} src/packages ./src/packages
COPY --chown=${USER_NAME}:${USER_NAME} src/agent ./src/agent

# Copy automation scripts to /app to avoid being overwritten by volume mounts
COPY --chown=${USER_NAME}:${USER_NAME} src/dockers/entrypoint.sh /app/entrypoint.sh
COPY --chown=${USER_NAME}:${USER_NAME} scripts/sync-plugins.sh /app/sync-plugins.sh
COPY --chown=${USER_NAME}:${USER_NAME} scripts/refresh-discovery-cache.sh /app/refresh-discovery-cache.sh
COPY --chown=${USER_NAME}:${USER_NAME} scripts/stop-hook.sh /app/scripts/stop-hook.sh
RUN mkdir -p /app/scripts && \
    chmod +x /app/entrypoint.sh /app/sync-plugins.sh /app/refresh-discovery-cache.sh /app/scripts/stop-hook.sh

# Install dependencies
RUN bun install

# Switch to non-root user for final execution
USER ${USER_NAME}

# Entrypoint handles initialization (like plugin sync)
ENTRYPOINT ["/app/entrypoint.sh"]

# Default command
CMD ["bun", "run", "src/agent/index.ts"]
