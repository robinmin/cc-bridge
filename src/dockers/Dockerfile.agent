# Base image
FROM oven/bun:1-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    # Essential tools
    git \
    curl \
    jq \
    sudo \
    # Process & system monitoring
    procps \
    psmisc \
    htop \
    lsof \
    # Development tools
    ripgrep \
    fd-find \
    tree \
    file \
    less \
    tmux \
    # Python (for Claude plugins)
    python3 \
    python3-pip \
    python3-venv \
    # Text editor
    nano \
    # Cleanup
    && rm -rf /var/lib/apt/lists/*

ARG USER_NAME=robin
ARG USER_ID=1000
ARG GROUP_ID=1000
ARG WORKSPACE_NAME=cc-bridge

# Simple user setup: ensure passwd/group entries exist for UID/GID
RUN mkdir -p /Users/${USER_NAME} && \
    (getent group ${GROUP_ID} >/dev/null 2>&1 || echo "${USER_NAME}:x:${GROUP_ID}:" >> /etc/group) && \
    (getent passwd ${USER_ID} >/dev/null 2>&1 || echo "${USER_NAME}:x:${USER_ID}:${GROUP_ID}::/Users/${USER_NAME}:/bin/bash" >> /etc/passwd)

# Ensure the home directory exists and is owned by the user (as root)
RUN mkdir -p /Users/${USER_NAME}/.claude && \
    chown -R ${USER_ID}:${GROUP_ID} /Users

# Ensure sudo privileges for the user (if sudo is needed)
RUN echo "${USER_NAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Ensure workspace directory structure exists and is writable
RUN mkdir -p /workspaces && \
    chown -R ${USER_ID}:${GROUP_ID} /workspaces

# Also keep /app for agent code execution
RUN mkdir -p /app && \
    chown -R ${USER_ID}:${GROUP_ID} /app

# Switch to non-root user
USER ${USER_ID}:${GROUP_ID}

# Install Claude tools in /app (NOT affected by volume mounts)
WORKDIR /app
RUN bun add @anthropic-ai/claude-code @anthropic-ai/claude-agent-sdk

# Set PATH at container level for all processes (no reliance on .bashrc)
# Includes: /app/node_modules/.bin (claude CLI), bun, jq, curl, tmux, etc.
ENV PATH="/app/node_modules/.bin:/usr/local/bun/bin:/usr/local/bin:/usr/bin:/bin:/usr/local/bun-node-fallback-bin"

# Set working directory to workspace (dynamic based on build arg)
WORKDIR /workspaces/${WORKSPACE_NAME}

# Bake Claude settings without Stop hook to avoid duplicate/early callbacks
USER root
COPY src/dockers/.claude/settings.json /tmp/claude-settings.json
RUN jq 'del(.hooks)' /tmp/claude-settings.json > /Users/${USER_NAME}/.claude/settings.json && \
    chown ${USER_ID}:${GROUP_ID} /Users/${USER_NAME}/.claude/settings.json && \
    rm -f /tmp/claude-settings.json
USER ${USER_ID}:${GROUP_ID}

# Copy dependency definitions
COPY --chown=${USER_NAME}:${USER_NAME} package.json bun.lock ./

# Copy internal packages and source
COPY --chown=${USER_NAME}:${USER_NAME} tsconfig.json ./
COPY --chown=${USER_NAME}:${USER_NAME} src/packages ./src/packages
COPY --chown=${USER_NAME}:${USER_NAME} src/agent ./src/agent

# Copy automation scripts to /app (container_cmd.sh is mounted via docker-compose.yml)
RUN mkdir -p /app/scripts
COPY --chown=${USER_NAME}:${USER_NAME} --chmod=755 scripts/sync-plugins.sh /app/sync-plugins.sh
COPY --chown=${USER_NAME}:${USER_NAME} --chmod=755 scripts/refresh-discovery-cache.sh /app/refresh-discovery-cache.sh
COPY --chown=${USER_NAME}:${USER_NAME} --chmod=755 scripts/resolve-llm-provider.sh /app/scripts/resolve-llm-provider.sh

# Install dependencies
RUN bun install


# Switch to non-root user for final execution
USER ${USER_ID}:${GROUP_ID}

# Entrypoint: initialize environment, then start agent server
# Use shell form to run init, then exec to bun (replaces shell PID)
