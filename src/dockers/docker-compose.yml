# version: '3.8'

services:
  claude-agent:
    build:
      context: ../..
      dockerfile: src/dockers/Dockerfile.agent
      args:
        - USER_NAME=${USER_NAME:-robin}
        - USER_ID=${USER_ID:-1000}
        - GROUP_ID=${GROUP_ID:-1000}
        - WORKSPACE_NAME=${WORKSPACE_NAME:-cc-bridge}
    image: cc-bridge:latest
    container_name: claude-${WORKSPACE_NAME:-cc-bridge}

    labels:
      - "cc-bridge.workspace=${WORKSPACE_NAME:-cc-bridge}"

    env_file:
      - ./.env

    # Volume mounts
    volumes:
      # Individual file mounts for Claude configuration
      # USER_NAME is passed from Makefile (defaults to current user)
      - ./.claude/settings.json:/Users/${USER_NAME}/.claude/settings.json:rw
      - ./.claude/CLAUDE.md:/Users/${USER_NAME}/.claude/CLAUDE.md:rw
      - ./.claude/memories/${WORKSPACE_NAME:-cc-bridge}:/Users/${USER_NAME}/.claude/projects/-workspaces-${WORKSPACE_NAME:-cc-bridge}/memory:rw

      # Persistent state and authentication from host
      - ~/.claude/plugins:/Users/${USER_NAME}/.claude/plugins:rw
      - ~/.claude/cache:/Users/${USER_NAME}/.claude/cache:rw
      - ~/.claude/statsig:/Users/${USER_NAME}/.claude/statsig:rw
      - ~/.claude/session-env:/Users/${USER_NAME}/.claude/session-env:rw
      - ~/.claude/bridge:/Users/${USER_NAME}/.claude/bridge:rw
      - ~/.claude/hooks:/Users/${USER_NAME}/.claude/hooks:rw

      # Fixed mount point for automation scripts (container_cmd.sh mounted here)
      - ../../scripts/container_cmd.sh:/app/scripts/container_cmd.sh:rw

      # Workspace volume mapping
      - ../../../${WORKSPACE_NAME:-cc-bridge}:/workspaces/${WORKSPACE_NAME:-cc-bridge}:rw

      # IPC directories
      - ../../data/ipc/${WORKSPACE_NAME:-cc-bridge}:/ipc/${WORKSPACE_NAME:-cc-bridge}:rw
      - ../../data/ipc/data:/ipc/data:rw
      - ../../data/logs:/workspaces/${WORKSPACE_NAME:-cc-bridge}/data/logs:rw

    # Environment variables
    environment:
      # Service name for logging
      - SERVICE_NAME=agent

      # Workspace settings
      - WORKSPACE_NAME=${WORKSPACE_NAME:-cc-bridge}
      - INSTANCE_NAME=${WORKSPACE_NAME:-cc-bridge}
      # Use TCP mode for faster IPC from host
      - AGENT_MODE=tcp
      - AGENT_TCP_PORT=3001
      - CLAUDE_AGENT_SKILLS=1
      # IPC callback payload mode (avoid NFS cache race)
      - IPC_MODE=${IPC_MODE:-callback_payload}

      # LLM provider selection (resolved to Claude CLI ANTHROPIC_* env vars at runtime)
      - LLM_PROVIDER=${LLM_PROVIDER:-anthropic}
      - LLM_ANTHROPIC_BASE_URL=${LLM_ANTHROPIC_BASE_URL:-}
      - LLM_ANTHROPIC_API_KEY=${LLM_ANTHROPIC_API_KEY:-}
      - LLM_ANTHROPIC_AUTH_TOKEN=${LLM_ANTHROPIC_AUTH_TOKEN:-}
      - LLM_OPENROUTER_BASE_URL=${LLM_OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      - LLM_OPENROUTER_API_KEY=${LLM_OPENROUTER_API_KEY:-}
      - LLM_PROXY_BASE_URL=${LLM_PROXY_BASE_URL:-}
      - LLM_PROXY_API_KEY=${LLM_PROXY_API_KEY:-}
      - LLM_PROXY_AUTH_TOKEN=${LLM_PROXY_AUTH_TOKEN:-}
      - LLM_ZAI_BASE_URL=${LLM_ZAI_BASE_URL:-}
      - LLM_ZAI_API_KEY=${LLM_ZAI_API_KEY:-}
      - LLM_ZAI_AUTH_TOKEN=${LLM_ZAI_AUTH_TOKEN:-}
      - LLM_MINIMAX_BASE_URL=${LLM_MINIMAX_BASE_URL:-}
      - LLM_MINIMAX_API_KEY=${LLM_MINIMAX_API_KEY:-}
      - LLM_MINIMAX_AUTH_TOKEN=${LLM_MINIMAX_AUTH_TOKEN:-}

      # Legacy direct Claude CLI auth env (kept for backward compatibility/fallback)
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_AUTH_TOKEN=${ANTHROPIC_AUTH_TOKEN:-}

      # Gateway callback URL for Stop Hook
      - GATEWAY_CALLBACK_URL=http://host.docker.internal:8080/claude-callback
      - GATEWAY_URL=http://host.docker.internal:8080

      # LRU History Cache (for performance optimization)
      - ENABLE_LRU_HISTORY=${ENABLE_LRU_HISTORY:-false}

      # IPC directories for filesystem communication
      - IPC_BASE_DIR=/ipc
      - IPC_DATA_DIR=/ipc/data
      # HTTP API Server Configuration
      - HTTP_PORT=${HTTP_PORT:-3000}
      - HTTP_HOST=${HTTP_HOST:-0.0.0.0}
      - HTTP_API_KEY=${HTTP_API_KEY:-dev-key-change-in-production}
      - HTTP_AUTH=${HTTP_AUTH:-true}
      - HTTP_RATE_LIMIT_MAX=${HTTP_RATE_LIMIT_MAX:-100}
      - HTTP_RATE_LIMIT_WINDOW=${HTTP_RATE_LIMIT_WINDOW:-1 minute}

      # Python settings
      - PYTHONUNBUFFERED=1

    # Working directory inside container
    working_dir: /workspaces/${WORKSPACE_NAME:-cc-bridge}

    # Keep stdin open and allocate tty for interactive sessions
    stdin_open: true
    tty: true

    # Restart policy (none for development, unless-stopped for production)
    restart: unless-stopped

    # Port mappings
    ports:
      - "${HTTP_PORT:-3000}:3000" # HTTP API Server
      - "3001:3001" # Agent IPC (TCP fallback for performance)

    # The bridge server communicates via a persistent Unix Domain Socket (low-latency)
    # with a fall back to 'docker exec' streams.
    # Start tmux server for persistent Claude sessions
    command:
      - sh
      - -c
      - /app/scripts/container_cmd.sh init

    # Health check
    healthcheck:
      test: ["CMD", "bun", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    # Network configuration
    networks:
      - claude-network

# Define network for container communication
networks:
  claude-network:
    driver: bridge
