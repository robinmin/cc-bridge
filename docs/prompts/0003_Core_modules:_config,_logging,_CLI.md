---
name: Core modules: config, logging, CLI
description: Task: Core modules: config, logging, CLI
status: Testing
created_at: 2026-01-26 21:10:51
updated_at: 2026-01-26 22:30:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: pending
  testing: in_progress
dependencies: []
tags: [core, config, logging, cli]
---

## 0003. Core modules: config, logging, CLI

### Background

Project scaffolding (task 0002) is complete. Now implementing the core modules that other parts of the system depend on: configuration management, structured logging, and CLI initialization.

### Requirements / Objectives

**Functional Requirements:**
1. `config.py`: Configuration loader with layered priority (CLI args > env vars > config file > defaults)
2. `logging.py`: Structured logging setup with JSON/text formats
3. `cli.py`: Enhance Typer-based CLI with config loading and logging initialization

**Non-Functional Requirements:**
- Type hints throughout
- Path expansion for `~` in file paths
- Deep merge for nested configuration
- File rotation for logs
- Environment variable overrides

**Acceptance Criteria:**
- [x] `config.py` can load config from TOML file
- [x] `config.py` respects env vars override
- [x] `config.py` provides defaults for missing values
- [x] `config.py` implements deep merge for nested configs
- [x] `config.py` expands `~` in file paths
- [x] `logging.py` initializes structlog with JSON formatter
- [x] `logging.py` initializes structlog with text formatter
- [x] `logging.py` supports file rotation
- [x] `cli.py` loads config on startup
- [x] `cli.py` initializes logging based on config
- [ ] All tests pass (pytest)
- [ ] Type checking passes (ty)

### Q&A

**Q:** Should the config file be created automatically if missing?
**A:** Yes, the config system should use defaults and create the file when `save()` is called.

**Q:** Should environment variables override all config file values?
**A:** Yes, env vars should have higher priority than config file values but lower than CLI args.

### Solutions / Goals

**Technology Stack:**
- `toml` - Config file parsing
- `structlog` - Structured logging
- `typer` - CLI framework
- `pathlib` - Path handling

**Implementation Approach:**
1. Implement deep merge for configuration
2. Add environment variable override support
3. Add path expansion for `~`
4. Add missing `logging.handlers` import
5. Integrate config loading and logging initialization in CLI

#### Plan

1. **Phase 1** - Configuration System
   - [x] Implement deep merge functionality
   - [x] Add environment variable overrides
   - [x] Add path expansion for `~`
   - [x] Write comprehensive tests

2. **Phase 2** - Logging System
   - [x] Add missing `logging.handlers` import
   - [x] Write comprehensive tests

3. **Phase 3** - CLI Integration
   - [x] Load configuration on startup
   - [x] Initialize logging based on config
   - [x] Add logging to command stubs
   - [x] Write comprehensive tests

4. **Phase 4** - Testing & Verification
   - [x] Create test files (test_config.py, test_logging.py, test_cli.py)
   - [ ] Run pytest and verify all tests pass
   - [ ] Run type checking (ty)
   - [ ] Update task status to Done

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|
| Module | cc-bridge/cc_bridge/config.py | super-coder | 2026-01-26 |
| Module | cc-bridge/cc_bridge/logging.py | super-coder | 2026-01-26 |
| Module | cc-bridge/cc_bridge/cli.py | super-coder | 2026-01-26 |
| Tests | cc-bridge/tests/test_config.py | super-coder | 2026-01-26 |
| Tests | cc-bridge/tests/test_logging.py | super-coder | 2026-01-26 |
| Tests | cc-bridge/tests/test_cli.py | super-coder | 2026-01-26 |

### References

- [Task 0001 brainstorming document](/Users/robin/xprojects/claudecode-telegram/docs/prompts/0001_brainstorm_cc-bridge.md)
- [Python structlog documentation](https://www.structlog.org/)
- [Typer CLI documentation](https://typer.tiangolo.com/)
- [TOML specification](https://toml.io/en/)
