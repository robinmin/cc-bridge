---
name: fix-cr001-http-response-format
description: Fix incorrect HTTP response format in server.py - returns tuples instead of proper FastAPI responses
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: CRITICAL
category: Bug
---

## 0041. fix-cr001-http-response-format

### Background

The FastAPI server in `cc_bridge/commands/server.py` incorrectly returns HTTP responses using tuple format like `{"status": ...}, 413`. This is a Flask-style pattern that does not work in FastAPI. FastAPI expects either a dictionary (which returns 200 OK) or proper response objects like `HTTPException` or `JSONResponse` with explicit status codes.

**Impact**: All error responses (rate limiting 429, payload too large 413, etc.) are being returned with 200 OK status codes, making:
- Rate limiting completely ineffective (clients don't see 429)
- Error handling broken (clients can't detect errors via status codes)
- Payload size limits unenforced from the client's perspective

**Affected Lines**:
- Line 201: Rate limit response
- Line 206: Rate limit response
- Line 233: Payload size error
- Line 239: Payload size error
- Line 409: Error response
- Line 413: Error response

### Requirements

**Functional Requirements:**
- Replace tuple-style returns with proper FastAPI response patterns
- Use `HTTPException` for error conditions (4xx, 5xx)
- Use `JSONResponse` when custom response body is needed with non-200 status
- Maintain backward compatibility with response body structure

**Non-Functional Requirements:**
- No changes to API contract (same JSON structure in responses)
- Proper HTTP semantics (correct status codes reach clients)

**Acceptance Criteria:**
- [x] All tuple-style returns in server.py are replaced with HTTPException or JSONResponse
- [x] Rate limit responses return actual 429 status code
- [x] Payload too large responses return actual 413 status code
- [x] Error responses return appropriate 4xx/5xx status codes
- [x] Unit tests verify correct status codes are returned
- [ ] Integration test confirms clients receive proper status codes

### Q&A

[Clarifications added during planning phase]

### Design

**Fix Pattern:**
```python
# Before (broken)
return {"status": "error", "message": "Rate limited"}, 429

# After (correct)
from fastapi import HTTPException
from fastapi.responses import JSONResponse

# Option 1: HTTPException (raises, stops execution)
raise HTTPException(status_code=429, detail="Rate limited")

# Option 2: JSONResponse (returns, allows custom body)
return JSONResponse(
    status_code=429,
    content={"status": "error", "message": "Rate limited"}
)
```

### Plan

1. Import `HTTPException` and `JSONResponse` from fastapi
2. Identify all tuple-style returns (6 locations)
3. Replace each with appropriate response type
4. Add unit tests for each error path
5. Run integration test to verify

### Implementation Notes

**Changes Made:**

1. **Import Added** (`cc_bridge/commands/server.py`, line 15):
   ```python
   from fastapi.responses import JSONResponse
   ```

2. **Replaced 6 tuple-style returns with JSONResponse:**
   - Line ~201: Request too large (413)
   - Line ~209: Empty update (400)
   - Line ~236: Rate limited (429)
   - Line ~245: Message too long (400)
   - Line ~415: Command execution failed (500)
   - Line ~420: Processing failed (500)

3. **Added unit tests** (`tests/test_commands/test_server.py`):
   - `test_webhook_empty_update_returns_400` - Verifies 400 for empty updates
   - `test_webhook_rate_limit_returns_429` - Verifies 429 for rate limiting
   - `test_webhook_message_too_long_returns_400` - Verifies 400 for long messages
   - `test_webhook_request_too_large_returns_413` - Verifies 413 for large payloads

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|
| Modified | cc_bridge/commands/server.py | super-coder | 2026-01-29 |
| Modified | tests/test_commands/test_server.py | super-coder | 2026-01-29 |

### References

- File: `cc_bridge/commands/server.py`
- Lines: 201, 206, 233, 239, 409, 413
- FastAPI Response docs: https://fastapi.tiangolo.com/advanced/custom-response/
