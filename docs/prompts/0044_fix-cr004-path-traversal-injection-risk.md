---
name: fix-cr004-path-traversal-injection-risk
description: Fix path traversal and command injection vulnerabilities in instance name handling
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: HIGH
category: Security
---

## 0044. fix-cr004-path-traversal-injection-risk

### Background

Instance names provided by users are used directly in security-sensitive contexts without proper validation or sanitization:

1. **File paths**: Instance names used to construct file paths could allow path traversal (e.g., `../../../etc/passwd`)
2. **Tmux session names**: Passed to shell commands, potential command injection
3. **Docker labels**: Used in Docker API calls without sanitization

**Affected Files:**
- `cc_bridge/core/instances.py`: File path construction
- `cc_bridge/commands/claude.py`: CLI argument handling

**Attack Scenarios:**
- Path traversal: Instance name `../../etc/passwd` could read/write arbitrary files
- Command injection: Instance name `; rm -rf /` in tmux commands
- Docker label injection: Malformed labels could affect container behavior

### Requirements

**Functional Requirements:**
- Validate instance names against a strict allowlist pattern
- Reject names with path separators, shell metacharacters, or special characters
- Sanitize names before use in file paths, shell commands, and Docker APIs

**Non-Functional Requirements:**
- Validation must happen at input boundary (CLI parsing)
- Clear error messages for invalid names
- No breaking changes for valid existing instance names

**Acceptance Criteria:**
- [x] Instance name validation function created with regex pattern
- [x] Validation applied at CLI input boundary
- [x] Path construction uses safe joining (no string concatenation)
- [x] Tmux commands use proper escaping or argument arrays
- [x] Docker labels are properly sanitized
- [x] Unit tests cover malicious input patterns
- [x] Security test suite with common attack payloads

### Q&A

### Design

**Safe Instance Name Pattern:**
```python
import re

INSTANCE_NAME_PATTERN = re.compile(r'^[a-zA-Z][a-zA-Z0-9_-]{0,63}$')

def validate_instance_name(name: str) -> bool:
    """Validate instance name is safe for use in paths/commands."""
    if not INSTANCE_NAME_PATTERN.match(name):
        raise ValueError(
            f"Invalid instance name: {name}. "
            "Must start with letter, contain only alphanumeric, underscore, hyphen, "
            "and be 1-64 characters."
        )
    return True
```

**Safe Path Construction:**
```python
from pathlib import Path

def get_instance_path(base_dir: Path, instance_name: str) -> Path:
    validate_instance_name(instance_name)
    path = base_dir / instance_name
    # Ensure path doesn't escape base directory
    if not path.resolve().is_relative_to(base_dir.resolve()):
        raise ValueError("Path traversal detected")
    return path
```

### Plan

1. [x] Create `validate_instance_name()` function with strict regex
2. [x] Apply validation at CLI entry points in `claude.py`
3. [x] Refactor path construction to use `pathlib` safely
4. [x] Update tmux commands to use subprocess with argument lists (not shell=True)
5. [x] Sanitize Docker labels
6. [x] Add comprehensive security tests

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|
| Security Module | cc_bridge/core/validation.py | rd2:super-coder | 2026-01-29 |
| Security Fixes | cc_bridge/core/instances.py | rd2:super-coder | 2026-01-29 |
| Security Fixes | cc_bridge/commands/claude.py | rd2:super-coder | 2026-01-29 |

### References

- Files: `cc_bridge/core/instances.py`, `cc_bridge/commands/claude.py`
- OWASP Path Traversal: https://owasp.org/www-community/attacks/Path_Traversal
- CWE-78 OS Command Injection: https://cwe.mitre.org/data/definitions/78.html

### Security Tests Added

**Malicious Inputs Rejected:**
- Path traversal: `../../etc/passwd`, `..\\windows\\system32`
- Command injection: `; rm -rf /`, `$(cat /etc/passwd)`, `| malicious`
- Special characters: `$`, `&`, `|`, `;`, `<`, `>`, `` ` ``, `(`, `)`, `{`, `}`
- Null bytes: `test\x00name`
- Reserved names: `all`, `list`, `status`, `help`, etc.
- Empty names: ``
- Names starting with numbers: `123instance`

**Valid Names Accepted:**
- Simple names: `claude`, `test`, `dev`
- With hyphens: `my-instance`, `dev-environment`
- With underscores: `my_instance`, `dev_environment`
- Mixed: `My_Instance-123`, `Test-Instance_01`
- Maximum length: 64 characters of valid pattern
