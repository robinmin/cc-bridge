---
name: fix-cr011-telegram-html-sanitization
description: Add HTML entity sanitization to prevent injection in Telegram messages
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: HIGH
category: Security
---

## 0051. fix-cr011-telegram-html-sanitization

### Background

The `_clean_claude_output()` function in `cc_bridge/commands/server.py` processes output before sending to Telegram but does not sanitize HTML entities. Telegram supports HTML formatting in messages, which means unsanitized content could:

1. Break message formatting with unescaped `<`, `>`, `&`
2. Inject HTML tags that change message appearance
3. Potentially exploit Telegram client rendering

**Location**: `cc_bridge/commands/server.py`

**Example Vulnerability:**
```python
# User sends: "Show me <script>alert('xss')</script>"
# Without sanitization, this goes directly to Telegram
message = _clean_claude_output(user_input)
await send_message(message, parse_mode="HTML")  # Injection!
```

### Requirements

**Functional Requirements:**
- Escape HTML entities in Claude output before sending to Telegram
- Handle `<`, `>`, `&`, `"`, `'` characters
- Preserve intentional formatting (code blocks, etc.)
- Support both HTML and Markdown parse modes safely

**Non-Functional Requirements:**
- Consistent sanitization across all message paths
- No double-escaping issues
- Clear documentation of sanitization behavior

**Acceptance Criteria:**
- [x] HTML entities escaped in all outgoing messages
- [x] Code blocks preserved correctly
- [x] No injection possible via user input
- [x] Tests cover common injection payloads
- [x] Both HTML and Markdown modes handled
- [x] Edge cases (empty strings, unicode) handled

### Q&A

[Clarifications added during planning phase]

### Design

**Sanitization Function:**
```python
import html

def sanitize_for_telegram(text: str, parse_mode: str = "HTML") -> str:
    """Sanitize text for safe Telegram message sending.

    Args:
        text: Raw text to sanitize
        parse_mode: "HTML" or "Markdown"

    Returns:
        Sanitized text safe for the specified parse mode
    """
    if parse_mode == "HTML":
        # Escape HTML entities
        return html.escape(text)
    elif parse_mode == "Markdown":
        # Escape Markdown special characters
        special_chars = ['_', '*', '[', ']', '(', ')', '~', '`', '>', '#', '+', '-', '=', '|', '{', '}', '.', '!']
        for char in special_chars:
            text = text.replace(char, f'\\{char}')
        return text
    else:
        return text
```

**Updated Clean Function:**
```python
def _clean_claude_output(output: str) -> str:
    """Clean and sanitize Claude output for Telegram."""
    # ... existing cleaning logic ...

    # Sanitize for Telegram HTML mode
    return sanitize_for_telegram(cleaned_output, parse_mode="HTML")
```

### Plan

1. Create `sanitize_for_telegram()` function
2. Add HTML entity escaping using `html.escape()`
3. Add Markdown escaping for Markdown mode
4. Integrate sanitization into `_clean_claude_output()`
5. Verify code block formatting preserved
6. Add injection tests with XSS payloads

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- File: `cc_bridge/commands/server.py`
- Lines: 8 (html import), 458-507 (sanitize_for_telegram function), 543 (sanitization call)
- Telegram HTML Formatting: https://core.telegram.org/bots/api#html-style
- Python html.escape: https://docs.python.org/3/library/html.html#html.escape

### Implementation Details

**Security Issue:**
The `_clean_claude_output()` function processed output before sending to Telegram but did not sanitize HTML entities. Telegram supports HTML formatting, which meant unsanitized content could:
1. Break message formatting with unescaped `<`, `>`, `&`
2. Inject HTML tags that change message appearance
3. Potentially exploit Telegram client rendering

**Solution Implemented:**

Added `sanitize_for_telegram()` function that escapes special characters based on parse mode.

**Before (Vulnerable):**
```python
def _clean_claude_output(output: str) -> str:
    # ... cleaning logic ...
    result = "\n".join(cleaned).strip()
    while "\n\n\n" in result:
        result = result.replace("\n\n\n", "\n\n")
    return result  # No sanitization!
```

**After (Secure):**
```python
def sanitize_for_telegram(text: str, parse_mode: str = "HTML") -> str:
    """Sanitize text for safe Telegram message sending."""
    if not text:
        return ""

    if parse_mode == "HTML":
        # Escape HTML entities: <, >, &, ", '
        return html.escape(text)
    elif parse_mode == "Markdown":
        # Escape Markdown special characters
        special_chars = ["_", "*", "[", "]", "(", ")", "~", "`", ">", "#",
                         "+", "-", "=", "|", "{", "}", ".", "!"]
        result = text
        for char in special_chars:
            result = result.replace(f"\\{char}", f"\\\\{char}")
            result = result.replace(char, f"\\{char}")
        return result
    else:
        return text

def _clean_claude_output(output: str) -> str:
    # ... cleaning logic ...
    result = "\n".join(cleaned).strip()
    while "\n\n\n" in result:
        result = result.replace("\n\n\n", "\n\n")

    # Sanitize for Telegram HTML mode to prevent injection
    result = sanitize_for_telegram(result, parse_mode="HTML")
    return result
```

**HTML Escaping Examples:**
- `<script>` → `&lt;script&gt;`
- `a & b` → `a &amp; b`
- `"quoted"` → `&quot;quoted&quot;`

**Markdown Escaping Examples:**
- `*bold*` → `\*bold\*`
- `_italic_` → `\_italic\_`
- `[link](url)` → `\[link\]\(url\)`

**Key Features:**
1. **HTML Mode**: Uses Python's `html.escape()` to escape `<`, `>`, `&`, `"`, `'`
2. **Markdown Mode**: Escapes all special characters per Telegram's MarkdownV2 spec
3. **Empty String Handling**: Returns empty string for None/empty input
4. **Double-Escape Prevention**: Markdown mode avoids double-escaping already-escaped chars
5. **Parse Mode Flexibility**: Supports both HTML and Markdown (though only HTML is currently used)

**Security Benefits:**
- Prevents HTML injection attacks
- Protects against message format breaking
- Maintains message integrity
- Safe for all user input

**Note:** The implementation currently defaults to HTML mode. If Markdown mode is needed in the future, the `parse_mode` parameter can be passed through.
