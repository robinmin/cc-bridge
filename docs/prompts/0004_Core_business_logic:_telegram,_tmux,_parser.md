---
name: Core business logic: telegram, tmux, parser
description: Task: Core business logic: telegram, tmux, parser
status: WIP
created_at: 2026-01-26 21:10:52
updated_at: 2026-01-26 22:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: in_progress
  review: pending
  testing: pending
---

## 0004. Core business logic: telegram, tmux, parser

### Background

Core modules (task 0003) are complete. Now implementing the business logic layer that handles external integrations. This task extracts the Telegram API client, tmux operations, and message parser from the POC `bridge.py` into reusable, testable modules.

### Requirements

**Functional Requirements:**

1. **telegram.py** - Telegram Bot API client
   - Async httpx-based client (replace urllib)
   - Send messages with HTML/Markdown formatting
   - Set/delete webhooks
   - Send chat actions (typing indicator)
   - Handle inline keyboards (callback queries)
   - Parse updates (messages, callbacks)
   - Error handling and retries

2. **tmux.py** - tmux operations wrapper
   - Check if tmux session exists
   - Send literal text (preserve special characters)
   - Send Enter key
   - Send Escape key (interrupt)
   - Create/attach session if needed

3. **parser.py** - Message formatting
   - Convert markdown to HTML
   - Handle code blocks (```language```)
   - Handle inline code (`code`)
   - Handle bold (**text**)
   - Handle italic (*text*)
   - Escape HTML entities
   - Truncate to 4000 chars (Telegram limit)

**Acceptance Criteria:**
- [ ] Telegram client can send messages
- [ ] Telegram client can set/delete webhooks
- [ ] tmux wrapper can check session existence
- [ ] tmux wrapper can send keys (literal, Enter, Escape)
- [ ] Parser converts markdown to HTML
- [ ] Parser handles code blocks correctly
- [ ] Parser truncates to 4000 chars
- [ ] All tests pass
- [ ] Type checking passes

**Non-Functional Requirements:**
- Async/await patterns for HTTP operations
- Type hints throughout
- Comprehensive error handling
- Test coverage > 80%

### Q&A

**Q: Should we maintain backward compatibility with bridge.py?**
A: Yes, bridge.py should continue to work. We'll refactor it to use the new modules.

**Q: What async library should we use?**
A: httpx (as specified in requirements). It's modern, supports both sync/async, and has better timeout handling than urllib.

### Design

**Technology Stack:**
- Python 3.10+
- httpx for async HTTP (replacing urllib)
- subprocess for tmux control
- re for regex parsing

**Architecture:**
```
src/
├── telegram.py    # TelegramClient class
├── tmux.py        # TmuxSession class
└── parser.py      # MarkdownParser class
tests/
├── test_telegram.py
├── test_tmux.py
└── test_parser.py
```

**Implementation Approach:**
1. Extract POC code into separate modules
2. Convert to async where appropriate (Telegram client)
3. Add comprehensive error handling
4. Write tests first (TDD)
5. Refactor bridge.py to use new modules

### Plan

**Phase 1: Telegram Client (telegram.py)**
- [ ] Create TelegramClient class
- [ ] Implement async send_message() with HTML support
- [ ] Implement send_chat_action() for typing indicator
- [ ] Implement set_webhook() and delete_webhook()
- [ ] Implement answer_callback_query()
- [ ] Implement set_my_commands()
- [ ] Add error handling and retries
- [ ] Write tests

**Phase 2: Tmux Wrapper (tmux.py)**
- [ ] Create TmuxSession class
- [ ] Implement session_exists() check
- [ ] Implement send_keys() with literal mode
- [ ] Implement send_enter()
- [ ] Implement send_escape()
- [ ] Add error handling
- [ ] Write tests

**Phase 3: Parser (parser.py)**
- [ ] Create MarkdownParser class
- [ ] Implement markdown_to_html() conversion
- [ ] Handle code blocks with language tags
- [ ] Handle inline code
- [ ] Handle bold and italic
- [ ] Implement HTML entity escaping
- [ ] Implement truncation to 4000 chars
- [ ] Write tests

**Phase 4: Integration**
- [ ] Update bridge.py to use new modules
- [ ] Verify backward compatibility
- [ ] Update dependencies (add httpx)
- [ ] Integration testing

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|
| Module | src/telegram.py | super-coder | 2026-01-26 |
| Module | src/tmux.py | super-coder | 2026-01-26 |
| Module | src/parser.py | super-coder | 2026-01-26 |
| Tests | tests/test_telegram.py | super-coder | 2026-01-26 |
| Tests | tests/test_tmux.py | super-coder | 2026-01-26 |
| Tests | tests/test_parser.py | super-coder | 2026-01-26 |

### References

**POC Code:**
- Current Telegram API: `bridge.py:36-49`
- Current tmux operations: `bridge.py:64-82`
- Current parser: `hooks/send-to-telegram.sh:40-56`

**Documentation:**
- Telegram Bot API: https://core.telegram.org/bots/api
- httpx docs: https://www.python-httpx.org/
- tmux manual: https://man.openbsd.org/tmux.1

**Related Tasks:**
- Task 0003: Core modules (config, logging, errors)
