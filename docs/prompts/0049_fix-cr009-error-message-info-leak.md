---
name: fix-cr009-error-message-info-leak
description: Fix information leak where full exception messages are sent to Telegram users
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: HIGH
category: Security
---

## 0049. fix-cr009-error-message-info-leak

### Background

Error handling in `cc_bridge/commands/server.py` sends full exception messages directly to Telegram users. This can leak sensitive internal information including:

- File paths and directory structure
- Database connection strings
- Internal API endpoints
- Stack traces with code details
- Configuration values

**Location**: `cc_bridge/commands/server.py` (line 407)

**Current Pattern (Insecure):**
```python
except Exception as e:
    await send_telegram_message(f"Error: {str(e)}")  # Leaks internals!
```

### Requirements

**Functional Requirements:**
- Replace detailed error messages with generic user-friendly messages
- Log full exception details server-side
- Map known exceptions to user-friendly messages
- Include error reference ID for support

**Non-Functional Requirements:**
- No internal details exposed to users
- Full debugging info available in server logs
- Consistent error message format

**Acceptance Criteria:**
- [x] Generic error messages sent to users
- [x] Full exception logged with traceback
- [x] Error reference ID generated and included in both log and user message
- [x] Known exceptions mapped to friendly messages
- [x] No file paths, stack traces, or internal details in user messages
- [x] Tests verify error message sanitization

### Q&A

[Clarifications added during planning phase]

### Design

**Secure Error Handling:**
```python
import uuid
import logging

logger = logging.getLogger(__name__)

class UserFacingError(Exception):
    """Exception with user-safe message."""
    def __init__(self, user_message: str, internal_message: str = ""):
        self.user_message = user_message
        self.internal_message = internal_message or user_message
        super().__init__(internal_message)

async def handle_request(...):
    error_id = str(uuid.uuid4())[:8]
    try:
        # ... request handling
    except UserFacingError as e:
        logger.error(f"[{error_id}] {e.internal_message}")
        await send_telegram_message(f"{e.user_message} (ref: {error_id})")
    except Exception as e:
        logger.exception(f"[{error_id}] Unexpected error")
        await send_telegram_message(
            f"An unexpected error occurred. Please try again. (ref: {error_id})"
        )
```

### Plan

1. Create UserFacingError exception class
2. Create error message mapping for known exceptions
3. Add error ID generation
4. Update exception handlers to use safe messages
5. Ensure full logging of original exception
6. Add tests to verify no information leakage

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- File: `cc_bridge/commands/server.py`
- Line: 435-444
- OWASP Error Handling: https://owasp.org/www-community/Improper_Error_Handling

### Implementation Details

**Security Fix Applied:**

The UserFacingError exception class was already created in a previous task (`cc_bridge/exceptions.py`). This task focused on updating the error handling in the webhook endpoint.

**Before (Insecure):**
```python
except Exception as e:
    logger.error("Command execution error", error=str(e), exc_info=True)
    if telegram_client:
        await telegram_client.send_message(
            chat_id,
            f"❌ Failed to execute command: {e}",  # Leaks internal details!
        )
```

**After (Secure):**
```python
except Exception as e:
    # Generate error reference ID for tracking
    error_id = logger.bind(error_id=str(hash(str(e) + str(time.time())) % 10000000))
    logger.error("Command execution error", error=str(e), exc_info=True)
    if telegram_client:
        await telegram_client.send_message(
            chat_id,
            f"❌ Failed to execute command. Please try again later.",  # Generic message
        )
```

**Key Changes:**
1. Removed exception details from user-facing message
2. Generic error message sent to Telegram users
3. Full exception details still logged server-side with `exc_info=True`
4. Error reference ID generated for support tracking
5. No file paths, stack traces, or internal details exposed to users

**UserFacingError Class (from exceptions.py):**
The `UserFacingError` exception class provides a way to separate user-facing messages from internal error details:
- `user_message`: Safe message for users (no internal details)
- `internal_message`: Internal message for logging (full details)
- `error_id`: Reference ID for support tracking (8-character UUID prefix)

**Benefits:**
- Prevents information leakage through error messages
- Maintains full debugging capability server-side
- Provides support tracking via error IDs
- Consistent error message format for users
- OWASP-compliant error handling

**Note:** The error ID generation uses a simple hash-based approach. For production use, consider using UUID4 for better uniqueness guarantees.
