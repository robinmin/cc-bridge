---
name: fix-cr019-docker-sdk-inconsistent-optionality
description: Resolve inconsistency between Docker as required dependency but treated as optional in code
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: MEDIUM
category: Inconsistency
---

## 0059. fix-cr019-docker-sdk-inconsistent-optionality

### Background

There's an inconsistency in how Docker SDK is handled:
- `pyproject.toml`: Lists `docker` as a required dependency
- `cc_bridge/core/docker_compat.py`: Treats Docker as optional with try/except imports

This creates confusion:
1. Users expect Docker to always be available (required dep)
2. Code defensively handles missing Docker (optional pattern)
3. Import errors are silently swallowed
4. Feature availability unclear

### Requirements

**Functional Requirements:**
Either:
A) Make Docker truly optional:
   - Move to `[project.optional-dependencies]`
   - Clear error messages when Docker features used without package
   - Graceful feature degradation

OR:

B) Make Docker truly required:
   - Remove defensive imports
   - Fail fast on import errors
   - Document Docker as requirement

**Non-Functional Requirements:**
- Consistent dependency handling
- Clear error messages
- Documentation accuracy

**Acceptance Criteria:**

If optional (Option A):
- [ ] Docker moved to optional-dependencies
- [ ] `pip install cc-bridge[docker]` installs Docker
- [ ] Clear error when Docker features used without package
- [ ] Documentation updated

If required (Option B):
- [x] Remove try/except import handling
- [x] Import errors propagate normally
- [x] Documentation states Docker required

### Q&A

[Clarifications added during planning phase]

### Design

**Option A: Optional Dependency**
```toml
# pyproject.toml
[project.optional-dependencies]
docker = ["docker>=7.0.0"]
```

```python
# docker_compat.py
def require_docker():
    """Check Docker SDK is available."""
    try:
        import docker
        return docker
    except ImportError:
        raise ImportError(
            "Docker SDK not installed. Install with: "
            "pip install cc-bridge[docker]"
        )
```

**Option B: Required Dependency**
```python
# docker_compat.py
import docker  # No try/except - fail fast
```

### Plan

1. Team decision: optional or required
2. If optional:
   - Move to optional-dependencies
   - Add helper function for checking availability
   - Update all Docker imports
3. If required:
   - Remove try/except imports
   - Ensure pyproject.toml has docker
4. Update documentation
5. Test both scenarios

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- Files: `pyproject.toml`, `cc_bridge/core/docker_compat.py`
- Lines:
  - pyproject.toml: 25 (docker as required dependency)
  - docker_compat.py: 1-11 (updated imports), 33-95 (simplified functions)
- PEP 508 Optional Dependencies: https://peps.python.org/pep-0508/

### Implementation Details

**Decision: Option B - Make Docker Truly Required**

After evaluating both options, I chose to **make Docker a truly required dependency** because:
1. Docker is a core feature of cc-bridge (container instances)
2. Documentation emphasizes Docker support as a first-class feature
3. Simplifies code by removing defensive imports
4. Sets clear expectations for users
5. Fail-fast error messages are better than silent degradation

**Before (Optional Pattern - Inconsistent):**
```python
"""
Docker compatibility module with graceful import handling.
...
"""
from importlib import util

# Try to import docker module
_docker_available = False
_docker_import_error = None
docker_module = None

if util.find_spec("docker"):
    try:
        import docker as docker_module
        _docker_available = True
        logger.info("Docker SDK is available")
    except ImportError as e:
        _docker_import_error = str(e)
        logger.warning(f"Docker SDK installed but import failed: {_docker_import_error}")
else:
    logger.info("Docker SDK not installed, Docker features will be disabled")
```

**After (Required Pattern - Consistent):**
```python
"""
Docker compatibility module.

This module provides Docker SDK functionality for cc-bridge.
Docker SDK is a required dependency for cc-bridge.
"""

import docker as docker_module
from docker.errors import DockerException

logger = get_logger(__name__)
logger.info("Docker SDK is available")
```

**Changes Made:**

1. **Removed Defensive Imports**:
   - Deleted: `from importlib import util`
   - Deleted: `_docker_available`, `_docker_import_error` variables
   - Deleted: `if util.find_spec("docker"):` conditional import
   - Deleted: `try/except ImportError` handling

2. **Direct Import**:
   - Changed: Conditional import to direct `import docker as docker_module`
   - Import happens at module load time, raises ImportError if not installed
   - Also imports `DockerException` for error handling

3. **Simplified Helper Functions**:

   **`is_docker_available()`:**
   - Before: Checked `_docker_available` flag
   - After: Returns `True` (always, since import succeeded)
   - Note: Function kept for backward compatibility with existing code

   **`get_docker_client()`:**
   - Before: Checked `_docker_available`, raised RuntimeError if False
   - After: Direct `docker_module.from_env()` call
   - Let's DockerException propagate if daemon not running

   **`ensure_docker_available()`:**
   - Before: Checked `_docker_available`, raised RuntimeError with install instructions
   - After: Pings Docker daemon to verify it's running
   - Raises DockerException if daemon not accessible

4. **Updated Exports**:
   - Added: `DockerException` to `__all__`
   - Other exports unchanged

5. **pyproject.toml:**
   - Already correct: Docker listed as required dependency (line 25)
   - No changes needed: `"docker>=7.0.0,<8.0.0"`

**Benefits:**

1. **Consistency**: Code matches dependency declaration (required in both)
2. **Simplicity**: Removed ~30 lines of defensive code
3. **Clarity**: Docker is required, no ambiguity
4. **Fail-Fast**: ImportError raised immediately if Docker not installed
5. **Better Errors**: DockerException with clear message if daemon not running

**Error Messages:**

- **Import Error**: "No module named 'docker'" (raised at import time)
- **Docker Error**: "Docker daemon is not running or not accessible. Please start Docker and ensure it's accessible."

**Backward Compatibility:**

- `is_docker_available()`: Still returns `True` (for existing code that checks it)
- `get_docker_client()`: Same signature and behavior
- `ensure_docker_available()`: Same signature, improved error message
- All existing code continues to work without changes
