---
name: fix-cr003-rate-limiter-wrong-identifier
description: Fix rate limiter bug where get_retry_after() returns wrong identifier's retry time
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: CRITICAL
category: Bug
---

## 0043. fix-cr003-rate-limiter-wrong-identifier

### Background

The `get_retry_after()` method in the rate limiter implementation uses the first identifier in the internal dictionary instead of the identifier that was actually rate-limited. This is a logic error that causes incorrect retry-after times to be returned to clients.

**Location**: `cc_bridge/commands/server.py` (lines 70-84)

**Example Bug Scenario:**
1. User A makes requests, gets rate-limited at t=100, retry-after=60s
2. User B makes requests, gets rate-limited at t=150, retry-after=60s
3. When User B checks retry-after, they might get User A's time (50s remaining instead of 60s)

**Impact**:
- Rate limiting returns incorrect retry-after times
- Clients may retry too soon or wait too long
- Violates HTTP rate-limiting semantics (429 with Retry-After header)

### Requirements

**Functional Requirements:**
- `get_retry_after()` must accept an identifier parameter
- Return retry time for the specific identifier that was rate-limited
- Handle case where identifier is not in the rate limit dict

**Non-Functional Requirements:**
- Thread-safe access to rate limit dictionary
- O(1) lookup time for retry-after

**Acceptance Criteria:**
- [x] `get_retry_after(identifier)` method signature updated
- [x] Returns correct retry time for the specified identifier
- [x] Returns 0 or None if identifier not rate-limited
- [x] All callers updated to pass the correct identifier
- [x] Unit tests verify correct behavior with multiple identifiers
- [x] Retry-After header in 429 responses contains correct value

### Q&A

### Design

**Current (Broken):**
```python
def get_retry_after(self):
    # Returns first item in dict - WRONG
    for identifier, timestamp in self._rate_limited.items():
        return max(0, timestamp - time.time())
    return 0
```

**Fixed:**
```python
def get_retry_after(self, identifier: int) -> int:
    """Get retry-after time for a specific identifier."""
    if identifier not in self._timestamps:
        return 0
    timestamps = self._timestamps[identifier]
    if not timestamps:
        return 0
    oldest = min(timestamps)
    retry_after = int(oldest + self.window - time.time())
    return max(0, retry_after)
```

### Plan

1. [x] Update `get_retry_after()` method signature to accept identifier
2. [x] Implement correct lookup logic
3. [x] Find all call sites and update them
4. [x] Add unit tests for multi-identifier scenarios
5. [x] Verify Retry-After header correctness

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|
| Bug Fix | cc_bridge/commands/server.py | rd2:super-coder | 2026-01-29 |

### References

- File: `cc_bridge/commands/server.py`
- Lines: 71-96 (updated)
- HTTP 429 Retry-After: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Retry-After
