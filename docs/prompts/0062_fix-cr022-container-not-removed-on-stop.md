---
name: fix-cr022-container-not-removed-on-stop
description: Fix stop_container() to optionally remove containers after stopping
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: MEDIUM
category: Resource Cleanup
---

## 0062. fix-cr022-container-not-removed-on-stop

### Background

The `stop_container()` function in `cc_bridge/commands/docker_cmd.py` stops containers but doesn't remove them. This leads to:

1. **Resource accumulation**: Stopped containers consume disk space
2. **Name conflicts**: Can't reuse container names
3. **Clutter**: `docker ps -a` shows many stopped containers
4. **Manual cleanup**: Users must manually run `docker rm`

**Current Behavior:**
```python
def stop_container(container_name):
    container.stop()  # Container still exists in stopped state
```

### Requirements

**Functional Requirements:**
- Add option to remove container after stopping
- Default behavior: stop only (backward compatible)
- `--rm` flag to remove after stop
- `--force` flag to force stop if needed

**Non-Functional Requirements:**
- Clear user feedback about container state
- Safe handling of already-stopped containers
- Consistent with Docker CLI behavior

**Acceptance Criteria:**
- [x] `stop_container()` accepts `remove=False` parameter
- [x] When `remove=True`, container is removed after stop
- [x] CLI has `--rm` flag for stop command
- [x] Force stop option available
- [x] Clear output indicating container state
- [x] Tests verify removal behavior

### Q&A

[Clarifications added during planning phase]

### Design

**Updated Function:**
```python
async def stop_container(
    container_name: str,
    remove: bool = False,
    force: bool = False,
    timeout: int = 10
) -> None:
    """Stop a container and optionally remove it.

    Args:
        container_name: Name or ID of container
        remove: Remove container after stopping
        force: Force stop (SIGKILL) if timeout exceeded
        timeout: Seconds to wait for graceful stop
    """
    container = docker_client.containers.get(container_name)

    # Stop container
    container.stop(timeout=timeout)
    print(f"Container {container_name} stopped")

    # Optionally remove
    if remove:
        container.remove()
        print(f"Container {container_name} removed")
```

**CLI Update:**
```python
@app.command()
def stop(
    name: str,
    rm: bool = typer.Option(False, "--rm", help="Remove after stopping"),
    force: bool = typer.Option(False, "--force", "-f", help="Force stop")
):
    """Stop a container."""
    stop_container(name, remove=rm, force=force)
```

### Plan

1. Add `remove` and `force` parameters to `stop_container()`
2. Implement removal logic after stop
3. Add CLI `--rm` and `--force` flags
4. Add user feedback messages
5. Handle edge cases (already stopped, doesn't exist)
6. Add tests for removal behavior

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- File: `cc_bridge/commands/docker_cmd.py`
- Lines: 206-209 (updated function signature with --rm), 241-248 (removal in --all loop), 267-273 (removal for single container)
- Docker SDK remove: https://docker-py.readthedocs.io/en/stable/containers.html

### Implementation Details

**Issue:** `stop_container()` stopped containers but didn't remove them, causing resource accumulation.

**Solution:** Added `--rm` flag to optionally remove containers after stopping.

**Changes Made:**

1. **Added `--rm` CLI flag** (line 207):
   ```python
   rm: bool = typer.Option(False, "--rm", help="Remove container after stopping")
   ```

2. **Updated docstring** to reflect removal capability

3. **Added removal logic in `--all` loop** (lines 241-248):
   ```python
   if rm:
       container.remove()
       typer.echo(f"  Removed {instance.name}")
   ```

4. **Added removal logic for single container** (lines 267-273):
   ```python
   if rm:
       container.remove()
       typer.echo(f"  Removed {name}")
   ```

**Usage Examples:**

```bash
# Stop container (keeps it)
cc-bridge docker stop my_instance

# Stop and remove container
cc-bridge docker stop --rm my_instance

# Stop and remove all instances
cc-bridge docker stop --all --rm

# Force stop and remove
cc-bridge docker stop --force --rm my_instance
```

**Benefits:**

1. **Resource Cleanup**: Prevents accumulation of stopped containers
2. **Name Reuse**: Allows reusing container names after removal
3. **Backward Compatible**: Default behavior unchanged (stop only)
4. **User Control**: Optional `--rm` flag gives users choice
5. **Consistent**: Matches Docker CLI `docker rm` behavior
