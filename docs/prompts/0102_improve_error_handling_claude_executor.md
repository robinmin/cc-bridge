---
name: improve-error-handling-claude-executor
description: Improve error handling and structured logging in claude-executor.ts
status: Done
created_at: 2026-02-06 00:00:00
updated_at: 2026-02-06 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: MEDIUM
category: Error Handling
---

## 0102. improve-error-handling-claude-executor

### Background

The `src/gateway/services/claude-executor.ts` file handles critical IPC communication with Claude agents but had inconsistent error handling patterns. Some errors were logged but not properly propagated, and structured logging could be improved for better debugging.

**Issues Fixed:**
1. Retry logic bug - `retries` was assigned but never decremented
2. Missing context in error logs
3. No custom error classes for error discrimination
4. No timeout/connection error detection for retry logic

### Requirements

**Functional Requirements:**
- Ensure all errors include sufficient context (containerId, instance name, etc.)
- Consistently apply structured logging throughout
- Distinguish clearly between retryable and fatal errors
- Ensure error propagation maintains error types

**Non-Functional Requirements:**
- Maintain existing retry logic behavior
- No breaking changes to error handling contract
- Follow existing logger patterns

**Acceptance Criteria:**
- [x] All error log statements include structured context
- [x] Error types are preserved through propagation
- [x] Retryable/fatal error distinction is clear
- [x] All error paths are covered by tests
- [x] Error messages include actionable information

### Q&A

**Q: Should we create custom error classes?**
**A:** Yes, creating specific error types (e.g., `IpcCommunicationError`, `ClaudeExecutionError`, `ValidationError`) improves error handling and allows for better error discrimination.

### Design

**Custom Error Classes:**
```typescript
export class ClaudeExecutionError extends Error {
  constructor(
    message: string,
    public readonly context: ErrorContext,
    cause?: Error,
  ) {
    super(message);
    this.name = 'ClaudeExecutionError';
    if (cause) {
      this.cause = cause;
    }
  }
}

export class IpcCommunicationError extends ClaudeExecutionError {
  constructor(message: string, context: ErrorContext, cause?: Error) {
    super(message, { ...context, operation: 'ipc_communication' }, cause);
    this.name = 'IpcCommunicationError';
  }
}

export class ValidationError extends ClaudeExecutionError {
  constructor(message: string, context: ErrorContext) {
    super(message, { ...context, operation: 'validation' });
    this.name = 'ValidationError';
  }
}
```

**Structured Logging Pattern:**
```typescript
logger.error(
  {
    error: errorMsg,
    containerId: instance.containerId,
    instanceName: instance.name,
    chatId,
    operation: 'execute_claude',
  },
  "IPC call failed permanently"
);
```

### Plan

1. [x] Create custom error classes in claude-executor.ts
2. [x] Update all error handling to use new error types
3. [x] Add structured logging context to all error paths
4. [x] Ensure error messages are actionable
5. [x] Add tests for error scenarios
6. [x] Update callers to handle new error types if needed

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|
| Implementation | src/gateway/services/claude-executor.ts | rd2:super-coder | 2026-02-06 |
| Tests | src/gateway/tests/claude-executor.test.ts | (existing) | N/A |

### References

- Related Tasks: 0103
- Files: `src/gateway/services/claude-executor.ts`, `src/gateway/pipeline/agent-bot.ts`
