---
name: fix-cr008-hardcoded-infrastructure-url
description: Remove hardcoded tunnel URL and make it configurable
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: HIGH
category: Security/Configuration
---

## 0048. fix-cr008-hardcoded-infrastructure-url

### Background

The server code contains a hardcoded tunnel URL: `"ccb.robinmin.net"` at line 281 of `cc_bridge/commands/server.py`. This exposes internal infrastructure details in the source code and prevents users from using their own tunnel endpoints.

**Issues:**
1. **Security**: Infrastructure details visible in public repository
2. **Flexibility**: Users can't configure their own tunnel URLs
3. **Maintenance**: URL changes require code changes
4. **Testing**: Hard to test with different endpoints

**Location**: `cc_bridge/commands/server.py` (line 281)

### Requirements

**Functional Requirements:**
- Move tunnel URL to configuration file
- Support environment variable override
- Provide sensible default (or require explicit configuration)
- Validate URL format

**Non-Functional Requirements:**
- No hardcoded infrastructure URLs in code
- Clear error message if tunnel URL not configured
- Documentation for tunnel configuration

**Acceptance Criteria:**
- [x] Tunnel URL removed from source code
- [x] Configuration option added to config schema
- [x] Environment variable CCBRIDGE_TUNNEL_URL supported
- [x] URL validation on configuration load
- [x] Error message if tunnel URL required but not set
- [x] Documentation updated with configuration instructions

### Q&A

### Design

**Configuration Schema Addition:**
```yaml
# config.yaml
tunnel:
  url: ""  # Optional - your tunnel endpoint
  # Can also use CCBRIDGE_TUNNEL_URL environment variable
```

**Code Pattern:**
```python
from cc_bridge.config import get_config

def get_tunnel_url() -> str:
    config = get_config()
    url = config.tunnel.url or os.environ.get("CCBRIDGE_TUNNEL_URL")
    if not url:
        raise ConfigurationError(
            "Tunnel URL not configured. Set tunnel.url in config.yaml "
            "or CCBRIDGE_TUNNEL_URL environment variable."
        )
    return url
```

### Plan

1. [x] Add `tunnel.url` to config schema in config.py
2. [x] Add environment variable support with CCBRIDGE_TUNNEL_URL
3. [x] Replace hardcoded URL with config lookup
4. [x] Add URL validation
5. [x] Update example config file
6. [x] Add documentation for tunnel configuration

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|
| Configuration Update | cc_bridge/config.py | rd2:super-coder | 2026-2026-01-29 |
| Server Update | cc_bridge/commands/server.py | rd2:super-coder | 2026-2026-01-29 |

### References

- File: `cc_bridge/commands/server.py`
- Line: 300 (updated)
- Config file: `cc_bridge/config.py`

### Implementation Details

**Configuration Changes:**
1. Added `"url": ""` to `tunnel` section in DEFAULTS
2. Added `"CCBRIDGE_TUNNEL_URL": "tunnel.url"` to env_mappings

**Server Changes:**
1. Removed hardcoded `"ccb.robinmin.net"` from status response
2. Added `get_config()` import (already existed)
3. Use `config_obj.get("tunnel.url", "")` to fetch URL
4. Parse URL to extract domain for display (hides full URL)
5. Show "Not configured" message when tunnel URL not set

**Environment Variable Support:**
Users can now set tunnel URL via:
- Config file: `tunnel.url = "https://your-tunnel.example.com"`
- Environment variable: `CCCRIDGE_TUNNEL_URL="https://your-tunnel.example.com"`

**Display Format:**
- When configured: Shows domain only (e.g., "your-tunnel.example.com")
- Not configured: Shows "Tunnel: Not configured"

**Security Benefits:**
- No infrastructure details in source code
- Users can use their own tunnels
- Easy to test with different endpoints
- Configuration can be environment-specific
