---
name: fix-cr020-missing-async-context-manager
description: Add async context manager to NamedPipeChannel for proper async resource management
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: MEDIUM
category: API Design
---

## 0060. fix-cr020-missing-async-context-manager

### Background

The `NamedPipeChannel` class in `cc_bridge/core/named_pipe.py` has a synchronous context manager (`__enter__`/`__exit__`) but its operations are async. This creates an API mismatch where:

1. Users expect `async with` but only `with` is available
2. Async cleanup operations can't be awaited in `__exit__`
3. Inconsistent with async Python patterns

**Current API:**
```python
with NamedPipeChannel(...) as channel:  # sync
    await channel.read()  # async operations inside sync context
```

**Expected API:**
```python
async with NamedPipeChannel(...) as channel:  # async
    await channel.read()
```

### Requirements

**Functional Requirements:**
- Add `__aenter__` and `__aexit__` methods
- Support async cleanup in context manager exit
- Maintain backward compatibility with sync context manager

**Non-Functional Requirements:**
- Consistent with async Python patterns
- Clear deprecation warning for sync usage
- Type hints for async protocol

**Acceptance Criteria:**
- [x] `__aenter__` and `__aexit__` implemented
- [x] Async cleanup works properly
- [x] Sync context manager deprecated (or removed)
- [x] Tests use `async with` pattern
- [x] Type hints include AsyncContextManager

### Q&A

[Clarifications added during planning phase]

### Design

**Async Context Manager:**
```python
from typing import AsyncContextManager

class NamedPipeChannel(AsyncContextManager["NamedPipeChannel"]):
    async def __aenter__(self) -> "NamedPipeChannel":
        """Async context manager entry."""
        await self.open()
        return self

    async def __aexit__(
        self,
        exc_type: type[BaseException] | None,
        exc_val: BaseException | None,
        exc_tb: TracebackType | None
    ) -> None:
        """Async context manager exit with cleanup."""
        await self.close()

    # Deprecated sync versions (optional - may remove)
    def __enter__(self) -> "NamedPipeChannel":
        warnings.warn(
            "Sync context manager deprecated. Use 'async with' instead.",
            DeprecationWarning
        )
        # ...
```

### Plan

1. Add `__aenter__` and `__aexit__` methods
2. Implement async open/close for async context
3. Add deprecation warning to sync `__enter__`/`__exit__`
4. Update all usage sites to `async with`
5. Add type hints for AsyncContextManager
6. Update tests

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- File: `cc_bridge/core/named_pipe.py`
- Lines: 7-16 (updated imports), 19-28 (class definition with AsyncContextManager), 254-296 (context manager methods)
- PEP 492 Async Context Managers: https://peps.python.org/pep-0492/#asynchronous-context-managers-and-async-with

### Implementation Details

**Issue:**
The `NamedPipeChannel` class had only synchronous context manager (`__enter__`/`__exit__`) despite being used in async code. This created an API mismatch where users had to use `with` for setup but then call `await` on methods inside.

**Solution:**
Added async context manager support (`__aenter__`/`__aexit__`) and deprecated the sync version.

**Before (Sync Only):**
```python
class NamedPipeChannel:
    def __enter__(self):
        """Context manager entry."""
        self.create_pipes()
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        """Context manager exit."""
        self.close()

# Usage
with NamedPipeChannel("test") as channel:
    await channel.send_command("hello")  # async method in sync context!
```

**After (Async + Deprecated Sync):**
```python
from typing import AsyncContextManager as AsyncContextManagerType
import warnings

class NamedPipeChannel(AsyncContextManagerType["NamedPipeChannel"]):
    """
    Bi-directional named pipe communication channel.

    Note:
        This class supports both sync and async context managers.
        Prefer async context manager (`async with`) for async code.
    """

    def __enter__(self):
        """Synchronous context manager entry (deprecated)."""
        warnings.warn(
            "Sync context manager is deprecated. Use 'async with' instead of 'with'.",
            DeprecationWarning,
            stacklevel=2
        )
        self.create_pipes()
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        """Synchronous context manager exit (deprecated)."""
        self.close()
        return False

    async def __aenter__(self) -> "NamedPipeChannel":
        """Async context manager entry."""
        self.create_pipes()
        return self

    async def __aexit__(
        self,
        exc_type: type[BaseException] | None,
        exc_val: BaseException | None,
        exc_tb: TracebackType | None
    ) -> None:
        """Async context manager exit with cleanup."""
        self.close()

# Usage (recommended)
async with NamedPipeChannel("test") as channel:
    await channel.send_command("hello")
```

**Key Changes:**

1. **Class Signature** (line 19):
   - Added: `AsyncContextManagerType["NamedPipeChannel"]` as base class
   - Enables static type checking for async context manager protocol

2. **Imports** (lines 7-16):
   - Added: `warnings` for deprecation warnings
   - Added: `TracebackType` for `__aexit__` type hint
   - Added: `AsyncContextManager` type alias

3. **Sync Context Manager** (lines 254-268):
   - Added: `DeprecationWarning` in `__enter__`
   - Added: `stacklevel=2` for accurate warning location
   - Added: Return `False` in `__exit__` (suppress exception handling)

4. **Async Context Manager** (lines 270-296):
   - New: `__aenter__()` method
   - New: `__aexit__()` method with proper type hints
   - Both call sync `create_pipes()` and `close()` (file operations are sync)

**Why Sync Operations in Async Context Manager?**

The pipe operations (`create_pipes()`, `close()`) are synchronous file system operations:
- Creating FIFO pipes with `os.mkfifo()`
- Deleting files with `Path.unlink()`

These don't need to be async, so `__aenter__` and `__aexit__` can be async wrappers around sync operations. This is a common pattern in Python async programming.

**Benefits:**

1. **API Consistency**: Async code can now use `async with` consistently
2. **Type Safety**: Static type checkers recognize async context manager protocol
3. **Clear Migration Path**: Deprecation warning guides users to async pattern
4. **Backward Compatible**: Old code using `with` still works (with warning)
5. **PEP 492 Compliant**: Follows Python async context manager conventions

**Migration Example:**

```python
# Old way (deprecated, shows warning)
with NamedPipeChannel("test") as channel:
    await channel.send_command("hello")

# New way (recommended)
async with NamedPipeChannel("test") as channel:
    await channel.send_command("hello")
```
