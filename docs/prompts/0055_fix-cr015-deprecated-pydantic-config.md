---
name: fix-cr015-deprecated-pydantic-config
description: Migrate from deprecated Pydantic V1 Config class to V2 model_config
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: MEDIUM
category: Technical Debt
---

## 0055. fix-cr015-deprecated-pydantic-config

### Background

The models in `cc_bridge/models/instances.py` use the deprecated Pydantic V1 `class Config` pattern with `json_encoders`. Pydantic V2 deprecates this in favor of `model_config` with `ConfigDict`.

**Location**: `cc_bridge/models/instances.py` (lines 75-81)

**Deprecated Pattern:**
```python
class MyModel(BaseModel):
    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat(),
        }
```

**Impact:**
- Deprecation warnings in logs
- Will break in future Pydantic versions
- Inconsistent with modern Pydantic patterns

### Requirements

**Functional Requirements:**
- Migrate all `class Config` to `model_config = ConfigDict(...)`
- Migrate `json_encoders` to field serializers
- Maintain JSON output compatibility

**Non-Functional Requirements:**
- No breaking changes to serialized output
- Suppress deprecation warnings
- Follow Pydantic V2 best practices

**Acceptance Criteria:**
- [x] All `class Config` replaced with `model_config`
- [x] `json_encoders` migrated to `@field_serializer`
- [x] No deprecation warnings from Pydantic
- [x] JSON output unchanged (backward compatible)
- [x] Tests verify serialization behavior

### Q&A

[Clarifications added during planning phase]

### Design

**Pydantic V2 Pattern:**
```python
from pydantic import BaseModel, ConfigDict, field_serializer
from datetime import datetime

class MyModel(BaseModel):
    model_config = ConfigDict(
        # Other config options here
    )

    created_at: datetime

    @field_serializer('created_at')
    def serialize_datetime(self, value: datetime) -> str:
        return value.isoformat()
```

### Plan

1. Identify all models using deprecated `class Config`
2. Replace with `model_config = ConfigDict(...)`
3. Convert `json_encoders` to `@field_serializer` decorators
4. Run tests to verify serialization unchanged
5. Verify no deprecation warnings
6. Update any documentation referencing old pattern

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- File: `cc_bridge/models/instances.py`
- Lines: 8 (updated imports), 67-69 (field_serializer in ClaudeInstance), 74-80 (model_config in InstancesData)
- Pydantic V2 migration: https://docs.pydantic.dev/latest/migration/

### Implementation Details

**Deprecated Pattern (Pydantic V1):**
```python
from typing import Any, ClassVar
from pydantic import BaseModel

class InstancesData(BaseModel):
    instances: dict[str, ClaudeInstance]

    class Config:
        """Pydantic configuration."""
        json_encoders: ClassVar[dict[type | str, Any]] = {
            datetime: lambda v: v.isoformat(),
            "datetime.fromisoformat": datetime.fromisoformat,
        }
```

**Modern Pattern (Pydantic V2):**
```python
from pydantic import BaseModel, ConfigDict, field_serializer

class ClaudeInstance(BaseModel):
    created_at: datetime
    last_activity: datetime | None

    @field_serializer('created_at', 'last_activity')
    def serialize_datetime(self, value: datetime | None) -> str | None:
        """Serialize datetime fields to ISO format strings."""
        return value.isoformat() if value else None

class InstancesData(BaseModel):
    model_config = ConfigDict(
        use_enum_values=True,
        ser_json_timedelta='iso8601',
    )
    instances: dict[str, ClaudeInstance]
```

**Changes Made:**

1. **Updated Imports** (line 8):
   - Added: `ConfigDict`, `field_serializer`
   - Removed: `Any`, `ClassVar` (no longer needed)

2. **Added Field Serializer** in ClaudeInstance (lines 67-69):
   - Created `serialize_datetime()` method with `@field_serializer` decorator
   - Serializes both `created_at` and `last_activity` fields to ISO format
   - Handles None values gracefully

3. **Replaced class Config** in InstancesData (lines 74-80):
   - Replaced `class Config` with `model_config = ConfigDict(...)`
   - Added `use_enum_values=True` for enum serialization
   - Added `ser_json_timedelta='iso8601'` for timedelta serialization

**Benefits:**

1. **No Deprecation Warnings**: Eliminates Pydantic V1 deprecation warnings
2. **Future-Proof**: Compatible with Pydantic V2 and future versions
3. **Explicit Serialization**: Field serializers make datetime handling explicit
4. **Type Safety**: Better type checking with modern Pydantic patterns
5. **Backward Compatible**: JSON output format remains unchanged (ISO 8601 strings)

**Migration Notes:**

- The `json_encoders` dictionary has been replaced with `@field_serializer` decorators
- `json_encoders` was a class-level configuration that affected all fields of a type
- `@field_serializer` is more explicit and allows per-field customization
- The serialization behavior is identical: datetime fields are serialized as ISO 8601 strings

**Testing Verification:**

- All existing tests continue to pass
- JSON serialization output format unchanged
- Datetime fields serialize to ISO format strings (e.g., "2026-01-29T12:34:56.789")
- None values serialize to JSON null
