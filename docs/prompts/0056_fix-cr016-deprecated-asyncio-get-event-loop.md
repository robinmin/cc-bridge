---
name: fix-cr016-deprecated-asyncio-get-event-loop
description: Replace deprecated asyncio.get_event_loop() with modern patterns
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: MEDIUM
category: Deprecation
---

## 0056. fix-cr016-deprecated-asyncio-get-event-loop

### Background

Multiple files use the deprecated `asyncio.get_event_loop()` function. In Python 3.10+, this raises a DeprecationWarning when called without a running event loop and will emit an error in Python 3.12+.

**Affected Files:**
- `cc_bridge/core/named_pipe.py`
- `cc_bridge/core/tmux.py`
- `cc_bridge/core/telegram.py`

**Deprecated Pattern:**
```python
loop = asyncio.get_event_loop()
loop.run_until_complete(coroutine)
```

### Requirements

**Functional Requirements:**
- Replace `get_event_loop()` with appropriate modern alternative
- Use `asyncio.get_running_loop()` within async context
- Use `asyncio.run()` for sync-to-async entry points

**Non-Functional Requirements:**
- No deprecation warnings
- Forward compatible with Python 3.12+
- Clear async/sync boundary handling

**Acceptance Criteria:**
- [x] All `get_event_loop()` calls replaced
- [x] Use `get_running_loop()` in async contexts
- [x] Use `asyncio.run()` for sync entry points
- [x] No DeprecationWarnings in test output
- [x] Works on Python 3.10, 3.11, 3.12

### Q&A

[Clarifications added during planning phase]

### Design

**Modern Patterns:**
```python
# ❌ Deprecated
loop = asyncio.get_event_loop()
result = loop.run_until_complete(coro)

# ✅ Modern: Sync entry point
result = asyncio.run(coro)

# ✅ Modern: Inside async function
async def my_func():
    loop = asyncio.get_running_loop()
    # Use loop for scheduling, executors, etc.
    result = await loop.run_in_executor(None, blocking_func)
```

**For mixed sync/async code:**
```python
def sync_function():
    try:
        loop = asyncio.get_running_loop()
    except RuntimeError:
        # No running loop - create one
        return asyncio.run(async_version())
    else:
        # Running loop exists - schedule task
        return loop.create_task(async_version())
```

### Plan

1. Search for all `asyncio.get_event_loop()` occurrences
2. Categorize each as: sync entry point, async context, or mixed
3. Replace sync entry points with `asyncio.run()`
4. Replace async contexts with `get_running_loop()`
5. Handle mixed cases appropriately
6. Test on Python 3.10, 3.11, 3.12

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- Files: `cc_bridge/core/named_pipe.py`, `cc_bridge/core/tmux.py`, `cc_bridge/core/telegram.py`, `cc_bridge/agents/container_agent.py`
- Lines:
  - telegram.py: 335-336, 374-375 (get_chat_id timeout loop)
  - named_pipe.py: 173, 177 (send_and_receive timeout loop)
  - tmux.py: 185, 191, 196 (send_command_and_wait timeout loop)
  - container_agent.py: 132, 198 (pipe I/O loops)
- asyncio deprecation: https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.get_event_loop

### Implementation Details

**Deprecated Pattern (Python 3.10-):**
```python
async def my_async_function():
    loop = asyncio.get_event_loop()  # Deprecated!
    start_time = loop.time()
    while loop.time() - start_time < timeout:
        # ... do work ...
```

**Modern Pattern (Python 3.10+):**
```python
async def my_async_function():
    loop = asyncio.get_running_loop()  # Modern!
    start_time = loop.time()
    while loop.time() - start_time < timeout:
        # ... do work ...
```

**Files Modified:**

1. **cc_bridge/core/telegram.py** (2 occurrences in `get_chat_id()`):
   - Lines 335-336: Timeout loop for webhook deletion
   - Lines 374-375: Timeout loop for update polling
   - Changed: `asyncio.get_event_loop()` → `asyncio.get_running_loop()`

2. **cc_bridge/core/named_pipe.py** (2 occurrences in `send_and_receive()`):
   - Lines 173, 177: Timeout loop for pipe reading
   - Changed: `asyncio.get_event_loop()` → `asyncio.get_running_loop()`

3. **cc_bridge/core/tmux.py** (3 occurrences in `send_command_and_wait()`):
   - Lines 185, 191, 196: Timeout loop for command execution
   - Changed: `asyncio.get_event_loop()` → `asyncio.get_running_loop()`

4. **cc_bridge/agents/container_agent.py** (2 occurrences):
   - Line 132: Pipe reader task loop
   - Line 198: Process reader task loop
   - Changed: `asyncio.get_event_loop()` → `asyncio.get_running_loop()`

**Why get_running_loop()?**
- All occurrences were within async functions (already in async context)
- `get_running_loop()` is the correct API for getting the current event loop
- Raises RuntimeError if called outside async context (catches bugs early)
- No deprecation warnings
- Forward compatible with Python 3.12+

**Total Changes:**
- 4 files modified
- 9 occurrences replaced
- 0 sync entry points found (all were async contexts)

**Testing:**
- All existing async tests continue to pass
- No behavior changes (same event loop, just different API)
- Compatible with Python 3.10, 3.11, 3.12+
