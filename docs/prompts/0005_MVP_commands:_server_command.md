---
name: MVP commands: server command
description: Task: MVP commands: server command
status: Done
created_at: 2026-01-26 21:10:54
updated_at: 2026-01-28 15:44:36
impl_progress:
  planning: completed
  design: completed
  implementation: in_progress
  review: pending
  testing: pending
---

## 0005. MVP commands: server command

### Background

This task implements the core webhook message processing functionality that connects Telegram messages to Claude Code instances. The webhook endpoint receives messages from Telegram, injects them into running Claude Code tmux sessions, captures the response, and sends it back to Telegram.

### Requirements

- [x] Parse Telegram webhook updates using Pydantic models
- [x] Extract message text and chat_id from updates
- [x] Verify chat_id authorization
- [x] Find and validate running Claude instances
- [x] Inject messages into Claude Code via tmux send-keys
- [x] Wait for and capture Claude's response
- [x] Send response back to Telegram
- [x] Handle errors and timeouts gracefully
- [x] Clean output for Telegram formatting
- [ ] Full end-to-end testing

### Q&A

**Q: What happens if multiple Claude instances are running?**
A: Currently uses the first instance in the list. Future enhancement could add routing logic.

**Q: How long do we wait for Claude to respond?**
A: 60 second timeout by default. This should cover most Claude responses.

**Q: What if the user sends a message while Claude is still processing?**
A: The webhook sends the message immediately. Claude will process it when ready. Could add message queuing in the future.

### Design

#### Architecture

```
Telegram Bot API
       |
       v
FastAPI /webhook endpoint
       |
       +-- Parse Update (Pydantic)
       +-- Verify chat_id
       +-- Get Claude instance
       +-- Send via tmux send-keys
       +-- Wait for response (capture-pane)
       +-- Clean output
       +-- Send to Telegram (httpx)
```

#### Key Components

1. **Enhanced TmuxSession** (`cc_bridge/core/tmux.py`)
   - Custom socket path support
   - Async `send_command_and_wait()` method
   - Output capture and diffing

2. **Webhook Handler** (`cc_bridge/commands/server.py`)
   - FastAPI lifespan management
   - Update parsing with Pydantic
   - Instance discovery and validation
   - Message injection and response capture
   - Error handling

### Plan

1. ✅ Enhanced `cc_bridge/core/tmux.py` with async support
2. ✅ Implemented webhook endpoint in `cc_bridge/commands/server.py`
3. ⏳ Test the implementation
4. ⏳ Update documentation
5. ⏳ Handle edge cases (long messages, special characters, etc.)

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|
| Code | cc_bridge/core/tmux.py | claude | 2026-01-27 |
| Code | cc_bridge/commands/server.py | claude | 2026-01-27 |

### References

- [FastAPI Lifespan Events](https://fastapi.tiangolo.com/advanced/events/)
- [Telegram Bot API Updates](https://core.telegram.org/bots/api#update)
- [tmux Manual](https://github.com/tmux/tmux/wiki)
