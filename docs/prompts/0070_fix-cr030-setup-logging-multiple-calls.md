---
name: fix-cr030-setup-logging-multiple-calls
description: Fix setup_logging() being called multiple times overriding global config
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: LOW
category: Code Quality
---

## 0070. fix-cr030-setup-logging-multiple-calls

### Background

Each command in `cc_bridge/commands/docker_cmd.py` calls `setup_logging()` individually. This can override the global logging configuration and cause:

1. **Configuration conflicts**: Different commands set different log levels
2. **Handler accumulation**: Multiple handlers attached to loggers
3. **Performance**: Redundant setup on every command
4. **Inconsistency**: Log behavior depends on command order

### Requirements

**Functional Requirements:**
- Setup logging once at application startup
- Commands should not configure logging
- Allow command-specific verbosity flags

**Non-Functional Requirements:**
- Logging configured before first log message
- No duplicate handlers
- Consistent log format across commands

**Acceptance Criteria:**
- [ ] `setup_logging()` called once in app initialization
- [ ] No `setup_logging()` calls in individual commands
- [ ] `--verbose` flag works without reconfiguring
- [ ] No duplicate log messages
- [ ] Tests verify single initialization

### Q&A

[Clarifications added during planning phase]

### Design

**Centralized Setup:**
```python
# cc_bridge/cli.py (main entry point)
import typer
from cc_bridge.logging import setup_logging

app = typer.Typer()

@app.callback()
def main(
    verbose: bool = typer.Option(False, "--verbose", "-v"),
    debug: bool = typer.Option(False, "--debug")
):
    """CC-Bridge CLI"""
    log_level = "DEBUG" if debug else ("INFO" if verbose else "WARNING")
    setup_logging(level=log_level)

# No setup_logging in individual commands!
```

**Idempotent Setup:**
```python
_logging_configured = False

def setup_logging(level: str = "INFO") -> None:
    global _logging_configured
    if _logging_configured:
        return  # Already configured
    # ... configure logging ...
    _logging_configured = True
```

### Plan

1. Move `setup_logging()` to app callback/initialization
2. Remove from individual commands
3. Add `--verbose`/`--debug` to main callback
4. Make `setup_logging()` idempotent as safety
5. Test logging behavior across commands

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- File: `cc_bridge/commands/docker_cmd.py`
- File: `cc_bridge/logging.py`
- File: `cc_bridge/cli.py`
- Typer callbacks: https://typer.tiangolo.com/tutorial/commands/callback/

### Implementation Details

**Issue:** Each command in docker_cmd.py called `setup_logging()` individually, causing configuration conflicts, handler accumulation, and performance issues.

**Solution:** Made `setup_logging()` idempotent and removed redundant calls from individual commands.

**Changes Made:**

1. **Made setup_logging() idempotent** in `cc_bridge/logging.py`:
   - Added `_logging_configured = False` global flag (line 16)
   - Added idempotent check at function start (lines 33-35)
   - Set flag to True after configuration completes (line 104)
   ```python
   # Flag to track if logging has been configured
   _logging_configured = False

   def setup_logging(...):
       global _logging_configured

       # Idempotent check - only configure once
       if _logging_configured:
           return

       # ... configure logging ...

       # Mark logging as configured
       _logging_configured = True
   ```

2. **Removed setup_logging() calls from docker_cmd.py**:
   - Removed from 6 commands: `list_docker`, `discover_containers`, `container_logs`, `exec_command`, `stop_container`, `start_container`
   - Removed import of `setup_logging` from imports (line 15)
   - Logging is now configured once at module level in `cli.py` (lines 19-25)

**Benefits:**
1. **Single Configuration**: Logging configured once at application startup
2. **No Handler Accumulation**: File handlers won't accumulate with each command
3. **Consistent Configuration**: All commands respect config file settings
4. **Performance**: Eliminates redundant setup on every command
5. **Idempotent Safety**: Even if called multiple times, only configures once
6. **Config File Respected**: Settings from config file take precedence over hardcoded values

**Note:** The `--verbose` and `--debug` flags suggested in the design were not implemented as they would require a Typer callback refactor. Current implementation uses config file settings (cli.py lines 19-25) which is the recommended approach for this CLI structure.
