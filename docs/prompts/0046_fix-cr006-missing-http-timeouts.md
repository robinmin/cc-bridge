---
name: fix-cr006-missing-http-timeouts
description: Add timeout configuration to TelegramClient HTTP requests
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: HIGH
category: Reliability
---

## 0046. fix-cr006-missing-http-timeouts

### Background

The `TelegramClient` class in `cc_bridge/core/telegram.py` does not configure timeouts for HTTP requests to the Telegram API. Without timeouts, the application can hang indefinitely waiting for responses from Telegram's servers.

**Impact:**
- Application hangs if Telegram API is slow or unresponsive
- No graceful degradation during network issues
- Resource exhaustion as hung requests accumulate
- Poor user experience with unresponsive CLI

**Scenarios Without Timeout:**
- Telegram API experiencing high latency
- Network connectivity issues
- DNS resolution delays
- TLS handshake stalls

### Requirements

**Functional Requirements:**
- Configure connect timeout (time to establish connection)
- Configure read timeout (time to receive response)
- Configure write timeout (time to send request)
- Make timeouts configurable via config file

**Non-Functional Requirements:**
- Sensible defaults (30s total, 10s connect)
- Clear timeout error messages
- Graceful degradation on timeout

**Acceptance Criteria:**
- [x] All HTTP requests have timeout configuration
- [x] Separate connect/read/write timeouts
- [x] Timeouts configurable in constructor
- [x] TimeoutError caught and converted to meaningful error
- [x] Tests verify timeout behavior
- [x] Documentation updated with timeout settings

### Q&A

### Design

**Timeout Configuration:**
```python
import httpx

# Default timeout settings
DEFAULT_TIMEOUT = httpx.Timeout(
    connect=10.0,    # Connection establishment
    read=30.0,       # Waiting for response
    write=10.0,      # Sending request
    pool=5.0         # Waiting for connection from pool
)

class TelegramClient:
    def __init__(self, token: str, timeout: httpx.Timeout | None = None):
        self._timeout = timeout or DEFAULT_TIMEOUT
        self._client = httpx.AsyncClient(timeout=self._timeout)
```

**Error Handling:**
```python
async def send_message(self, ...):
    try:
        response = await self._client.post(...)
    except httpx.TimeoutException as e:
        raise TelegramTimeoutError(
            f"Telegram API request timed out after {self._timeout.read}s"
        ) from e
```

### Plan

1. [x] Define timeout constants with sensible defaults
2. [x] Add timeout parameter to TelegramClient constructor
3. [x] Configure httpx.AsyncClient with timeout
4. [x] Create TelegramTimeoutError exception
5. [x] Add timeout error handling to all API methods
6. [x] Write tests with mocked slow responses

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|
| Exception Module | cc_bridge/exceptions.py | rd2:super-coder | 2026-01-29 |
| Timeout Implementation | cc_bridge/core/telegram.py | rd2:super-coder | 2026-01-29 |

### References

- File: `cc_bridge/core/telegram.py`
- httpx Timeouts: https://www.python-httpx.org/advanced/#timeout-configuration

### Timeout Configuration

**Default Timeouts:**
- **Connect timeout**: 10 seconds (TCP connection + TLS handshake)
- **Read timeout**: 30 seconds (waiting for API response)
- **Write timeout**: 10 seconds (sending request data)
- **Pool timeout**: 5 seconds (acquiring connection from pool)

**Total maximum request time:** ~55 seconds (connect + read + write)

**Constructor Parameters:**
```python
client = TelegramClient(
    bot_token=token,
    connect_timeout=10.0,
    read_timeout=30.0,
    write_timeout=10.0,
    pool_timeout=5.0,
    max_connections=10,
    max_keepalive_connections=5,
)
```

**Error Handling:**
All API methods now catch `httpx.TimeoutException` and convert to `TelegramTimeoutError` with clear error messages including timeout values.
