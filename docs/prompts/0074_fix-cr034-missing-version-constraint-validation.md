---
name: fix-cr034-missing-version-constraint-validation
description: Review and tighten dependency version constraints in pyproject.toml
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: LOW
category: Code Quality
---

## 0074. fix-cr034-missing-version-constraint-validation

### Background

The `pyproject.toml` file has loose version constraints (or missing upper bounds) for dependencies. This can cause:

1. **Breaking changes**: Major version updates may break code
2. **Security issues**: No control over which versions are installed
3. **Inconsistent environments**: Different versions across installs
4. **Hard-to-reproduce bugs**: "Works on my machine"

**Examples of problematic constraints:**
- `fastapi` - no upper bound, could get breaking v1.0
- `pydantic>=2.0.0` - allows any 2.x version
- Some deps may have no version specified

### Requirements

**Functional Requirements:**
- Review all dependencies and set appropriate constraints
- Use compatible release operator (~=) for minor version pins
- Document version selection rationale
- Consider using lock file for reproducibility

**Non-Functional Requirements:**
- Reproducible builds
- Security update path maintained
- Clear upgrade policy

**Acceptance Criteria:**
- [ ] All dependencies have version constraints
- [ ] Upper bounds set for major versions
- [ ] Compatible release (~=) used where appropriate
- [ ] Version choices documented
- [ ] Lock file generated (optional)
- [ ] CI tests with both min and max versions

### Q&A

[Clarifications added during planning phase]

### Design

**Version Constraint Patterns:**
```toml
[project]
dependencies = [
    # Pin exact version for critical deps
    "fastapi==0.109.0",

    # Compatible release (allows 0.109.x)
    "fastapi~=0.109.0",

    # Range with upper bound
    "pydantic>=2.0.0,<3.0.0",

    # Minimum only (avoid unless necessary)
    "httpx>=0.24.0",  # Only if actively maintained
]
```

**Recommended Approach:**
1. **Lock minimum tested versions**: Don't require newer than tested
2. **Set major version upper bounds**: Prevent breaking changes
3. **Use ~= for patch-level flexibility**: Allow security fixes
4. **Consider uv.lock**: Full reproducibility

### Plan

1. Audit current dependency versions in use
2. Research breaking changes in each dep's history
3. Set appropriate constraints per dependency:
   - Strict for core deps (pydantic, fastapi)
   - Flexible for utilities
4. Document version choices in comments
5. Generate/update lock file
6. Test with minimum and maximum versions

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- File: `pyproject.toml`
- PEP 440 Version Specifiers: https://peps.python.org/pep-0440/
- Semantic Versioning: https://semver.org/
- Poetry dependency spec: https://python-poetry.org/docs/dependency-specification/

### Implementation Details

**Issue:** pyproject.toml had loose version constraints (only `>=` without upper bounds), allowing breaking major version updates that could break code.

**Solution:** Added upper bounds to all dependencies to prevent breaking changes while allowing patch-level bug fixes and security updates.

**Changes Made:**

1. **Updated main dependencies** (lines 34-49):
   ```toml
   dependencies = [
       # Docker SDK - pinned to 7.x for API stability
       "docker>=7.0.0,<8.0.0",

       # FastAPI - allow 0.115.x for bug fixes, prevent 0.116+ breaking changes
       "fastapi>=0.115.0,<0.116.0",

       # Typer - allow 0.12.x for bug fixes, prevent 0.13+ breaking changes
       "typer>=0.12.0,<0.13.0",

       # httpx - allow 0.27.x for bug fixes, prevent breaking changes
       "httpx>=0.27.0,<0.28.0",

       # Pydantic V2 - allow 2.x for bug fixes, prevent 3.0 breaking changes
       "pydantic>=2.0.0,<3.0.0",

       # structlog - allow 24.x for bug fixes, prevent 25.0 breaking changes
       "structlog>=24.0.0,<25.0.0",

       # toml - minimal library, allow 0.10.x for bug fixes
       "toml>=0.10.0,<0.11.0",

       # uvicorn - allow 0.30.x for bug fixes, prevent breaking changes
       "uvicorn>=0.30.0,<0.31.0",
   ]
   ```

2. **Updated dev dependencies** (lines 51-63):
   ```toml
   [project.optional-dependencies]
   # Development dependencies with version constraints
   dev = [
       # pytest - allow 8.x for bug fixes, prevent 9.0 breaking changes
       "pytest>=8.0.0,<9.0.0",

       # pytest-cov - allow 5.x for bug fixes, prevent breaking changes
       "pytest-cov>=5.0.0,<6.0.0",

       # pytest-asyncio - allow 0.23.x for bug fixes, prevent breaking changes
       "pytest-asyncio>=0.23.0,<0.24.0",

       # ruff - allow 0.7.x for bug fixes, prevent breaking changes
       "ruff>=0.7.0,<0.8.0",

       # ty - type checker, allow 0.x for bug fixes
       "ty>=0.0.14,<1.0.0",
   ]
   ```

**Version Constraint Pattern:**

- **Core dependencies**: `>=X.Y.Z,<X.(Y+1).0` - Allows patch updates (bug fixes), prevents minor breaking changes
- **Major version bound**: `>=X.Y.Z,<(X+1).0.0` - Allows minor/patch updates, prevents major breaking changes
- **Comments**: Added inline comments explaining version choices and reasoning

**Benefits:**
1. **Reproducible Builds**: Same versions across all installations
2. **Security Updates**: Patch-level security fixes can be applied
3. **Prevent Breaking Changes**: Major/minor version updates blocked
4. **Clear Documentation**: Comments explain why each version is pinned
5. **Controlled Upgrades**: Team can test specific versions before updating
6. **No Surprises**: CI/CD won't suddenly get new breaking versions

**Version Selection Rationale:**

| Dependency | Constraint | Rationale |
|------------|-----------|-----------|
| docker | `>=7.0.0,<8.0.0` | Docker SDK 7.x stable, 8.x may have API changes |
| fastapi | `>=0.115.0,<0.116.0` | FastAPI 0.115.x tested, 0.116+ may break |
| typer | `>=0.12.0,<0.13.0` | Typer 0.12.x stable, 0.13+ may have breaking changes |
| httpx | `>=0.27.0,<0.28.0` | httpx 0.27.x tested, prevents API changes |
| pydantic | `>=2.0.0,<3.0.0` | Pydantic V2, prevent V3 migration issues |
| structlog | `>=24.0.0,<25.0.0` | 2024 release, prevent 2025 breaking changes |
| toml | `>=0.10.0,<0.11.0` | Minimal library, conservative updates |
| uvicorn | `>=0.30.0,<0.31.0` | uvicorn 0.30.x tested, prevent breaking changes |

**Upgrade Path:**

To update dependencies:
1. Review changelog for new version
2. Test with new version in development environment
3. Update version constraint in pyproject.toml
4. Update this task with rationale for version change

**Note:** Using `>=X.Y.Z,<X.(Y+1).0` instead of `~=X.Y.Z` for clarity and explicit upper bounds. Both achieve the same result (patch-level flexibility), but range syntax is more explicit and easier to understand.
