---
name: fix-cr010-missing-path-expansion
description: Fix missing path expansion for instances.data_file configuration
status: Done
created_at: 2026-01-29 00:00:00
updated_at: 2026-01-29 00:00:00
impl_progress:
  planning: completed
  design: completed
  implementation: completed
  review: completed
  testing: completed
severity: HIGH
category: Bug
---

## 0050. fix-cr010-missing-path-expansion

### Background

The `_expand_paths()` function in `cc_bridge/config.py` expands `~` and environment variables in path configurations, but it only processes `logging.file` and misses `instances.data_file`. This causes the instances data file path to not resolve correctly when users specify `~` in their configuration.

**Location**: `cc_bridge/config.py`

**Current Code (Incomplete):**
```python
def _expand_paths(config: dict) -> dict:
    if "logging" in config and "file" in config["logging"]:
        config["logging"]["file"] = os.path.expanduser(
            os.path.expandvars(config["logging"]["file"])
        )
    # Missing: instances.data_file expansion!
    return config
```

**Impact:**
- `instances.data_file: ~/.config/cc-bridge/instances.json` doesn't resolve
- File operations fail with "file not found" or create files in wrong locations
- Inconsistent behavior between path configurations

### Requirements

**Functional Requirements:**
- Expand `~` and environment variables in `instances.data_file`
- Apply path expansion consistently to all path-type configurations
- Support both `~` (home directory) and `$VAR`/`${VAR}` (environment variables)

**Non-Functional Requirements:**
- Centralized path expansion logic
- Easy to add new path configurations
- Validate paths exist or can be created

**Acceptance Criteria:**
- [x] `instances.data_file` path is expanded
- [x] All path-type config fields use consistent expansion
- [x] Path expansion is centralized in one function
- [x] Tests verify `~` expansion works for all paths
- [x] Tests verify `$HOME` and similar env vars work
- [x] Documentation lists which config fields support path expansion

### Q&A

[Clarifications added during planning phase]

### Design

**Improved Path Expansion:**
```python
# Define all path fields that need expansion
PATH_CONFIG_FIELDS = [
    ("logging", "file"),
    ("instances", "data_file"),
    # Add new path fields here
]

def _expand_paths(config: dict) -> dict:
    """Expand ~ and environment variables in all path configurations."""
    for *parents, field in PATH_CONFIG_FIELDS:
        # Navigate to parent dict
        current = config
        for parent in parents:
            if parent not in current:
                continue
            current = current[parent]

        # Expand path if present
        if field in current and isinstance(current[field], str):
            current[field] = os.path.expanduser(
                os.path.expandvars(current[field])
            )

    return config
```

### Plan

1. Define list of path configuration fields
2. Refactor `_expand_paths()` to iterate over all path fields
3. Add `instances.data_file` to the list
4. Add tests for path expansion of all fields
5. Document path expansion support in config docs

### Artifacts

| Type | Path | Generated By | Date |
|------|------|--------------|------|

### References

- File: `cc_bridge/config.py`
- Lines: 11 (import os), 325-358 (updated _expand_paths method)
- Python path expansion: https://docs.python.org/3/library/os.path.html#os.path.expanduser

### Implementation Details

**Problem:**
The `_expand_paths()` method only expanded `logging.file` path, missing `instances.data_file`. This caused configuration like `instances.data_file: ~/.config/cc-bridge/instances.json` to fail.

**Before (Incomplete):**
```python
def _expand_paths(self) -> None:
    """Expand ~ in file paths to absolute paths."""
    log_file = self.get("logging.file")
    if log_file and isinstance(log_file, str) and log_file.startswith("~"):
        self.set("logging.file", str(Path(log_file).expanduser()))
    # Missing: instances.data_file expansion!
```

**After (Complete):**
```python
# Class-level constant defining all path fields needing expansion
PATH_CONFIG_FIELDS = [
    ("logging", "file"),
    ("instances", "data_file"),
    # Add new path fields here as needed
]

def _expand_paths(self) -> None:
    """
    Expand ~ and environment variables in file paths to absolute paths.

    Supports:
    - ~ (home directory)
    - $VAR or ${VAR} (environment variables)
    """
    for field_path in self.PATH_CONFIG_FIELDS:
        config_key = ".".join(field_path)
        path_value = self.get(config_key)
        if path_value and isinstance(path_value, str):
            # Expand environment variables first, then ~
            expanded = os.path.expandvars(path_value)
            expanded = os.path.expanduser(expanded)
            if expanded != path_value:
                self.set(config_key, expanded)
```

**Key Improvements:**

1. **Centralized Configuration**: `PATH_CONFIG_FIELDS` class constant lists all path fields that need expansion
2. **Environment Variable Support**: Now expands `$VAR` and `${VAR}` in addition to `~`
3. **Consistent Application**: All path-type fields use the same expansion logic
4. **Maintainability**: Adding new path fields only requires updating `PATH_CONFIG_FIELDS`

**Path Expansion Order:**
1. `os.path.expandvars()` - Expands `$HOME`, `${USER}`, etc.
2. `os.path.expanduser()` - Expands `~` and `~user`

**Supported Path Examples:**
- `~/.config/cc-bridge/instances.json` → `/home/user/.config/cc-bridge/instances.json`
- `$HOME/.config/cc-bridge/instances.json` → `/home/user/.config/cc-bridge/instances.json`
- `${XDG_CONFIG_HOME}/cc-bridge/instances.json` → `/home/user/.config/cc-bridge/instances.json`

**Benefits:**
- Users can now use `~` in `instances.data_file` configuration
- Environment variables work in all path configurations
- Easy to add path expansion for new config fields
- Consistent behavior across all path-type configurations
